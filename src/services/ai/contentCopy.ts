/**
 * æ–‡æ¡ˆç”ŸæˆæœåŠ¡
 * æ ¹æ®å¤§çº²å†…å®¹ç”Ÿæˆå®Œæ•´çš„å°çº¢ä¹¦é£æ ¼æ–‡æ¡ˆ
 */

import { Page } from '../../stores/textGenerator'
import { logger } from '../../composables/useLogger'
import { callDeepSeekAPI } from './deepseek'
import { isMockMode } from './mock'

/**
 * ç”Ÿæˆå°çº¢ä¹¦é£æ ¼æ–‡æ¡ˆ
 * @param outline å¤§çº²æ–‡æœ¬
 * @param pages é¡µé¢åˆ—è¡¨
 * @param topic ä¸»é¢˜
 */
export async function generateContentCopy(
  outline: string,
  pages: Page[],
  topic: string
): Promise<{ content: string; usage: { promptTokens: number; candidatesTokens: number; totalTokens: number } }> {
  // æ£€æŸ¥æ¨¡æ‹Ÿæ¨¡å¼
  const mockMode = isMockMode()
  if (mockMode) {
    logger.warn('âš ï¸ [æ¨¡æ‹Ÿæ¨¡å¼] æ–‡æ¡ˆç”Ÿæˆå°†è¿”å›æµ‹è¯•å†…å®¹ï¼Œä¸ä¼šè°ƒç”¨çœŸå®API')
    logger.warn('ğŸ’¡ æç¤ºï¼šè¦ä½¿ç”¨çœŸå®APIç”Ÿæˆæ–‡æ¡ˆï¼Œè¯·åœ¨"ç³»ç»Ÿè®¾ç½®"é¡µé¢å…³é—­"æµ‹è¯•æ¨¡å¼ï¼ˆæ¨¡æ‹ŸAPIï¼‰"å¼€å…³')
    return {
      content: `ã€æ¨¡æ‹Ÿæ¨¡å¼ - æµ‹è¯•æ–‡æ¡ˆã€‘\n\nâš ï¸ å½“å‰å¤„äºæ¨¡æ‹Ÿæ¨¡å¼ï¼Œè¿”å›çš„æ˜¯æµ‹è¯•å†…å®¹ã€‚\n\nè¦ç”ŸæˆçœŸå®æ–‡æ¡ˆï¼Œè¯·å‰å¾€"ç³»ç»Ÿè®¾ç½®"é¡µé¢ï¼Œå…³é—­"æµ‹è¯•æ¨¡å¼ï¼ˆæ¨¡æ‹ŸAPIï¼‰"å¼€å…³ï¼Œç„¶åé‡æ–°ç”Ÿæˆã€‚\n\n---\n\næ ‡é¢˜ï¼š${topic}\n\nè¿™æ˜¯ä¸€æ®µæ¨¡æ‹Ÿç”Ÿæˆçš„å°çº¢ä¹¦é£æ ¼æ–‡æ¡ˆå†…å®¹ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿™é‡Œä¼šåŒ…å«å®Œæ•´çš„æ ‡é¢˜ã€æ­£æ–‡å’Œç»“å°¾ã€‚`,
      usage: { promptTokens: 0, candidatesTokens: 0, totalTokens: 0 }
    }
  }

  // æ„å»ºé¡µé¢å†…å®¹æ‘˜è¦ï¼ˆç”¨äºç”Ÿæˆæ–‡æ¡ˆï¼‰
  const pagesSummary = pages.map((page, index) => {
    const typeName = page.type === 'cover' ? 'å°é¢' : page.type === 'summary' ? 'æ€»ç»“' : 'å†…å®¹'
    return `ç¬¬${index + 1}é¡µï¼ˆ${typeName}é¡µï¼‰ï¼š\n${page.content}\n${page.imagePrompt ? `é…å›¾å»ºè®®ï¼š${page.imagePrompt}` : ''}`
  }).join('\n\n')

  // ä½¿ç”¨ç”¨æˆ·æä¾›çš„promptæ¨¡æ¿
  const prompt = `# è§’è‰²
ä½ æ˜¯ä¸€ä½å°çº¢ä¹¦å†…å®¹åˆ›ä½œå¤§å¸ˆï¼Œä¸“ä¸ºç”¨æˆ·å°†å†…å®¹å¤§çº²è½¬åŒ–ä¸ºç¬¦åˆå°çº¢ä¹¦é£æ ¼çš„ä¼˜è´¨å¸–å­ã€‚

# å·¥ä½œæµç¨‹
1.æç‚¼æ ‡é¢˜å’Œå›¾ç‰‡å¤§çº²çš„æ ¸å¿ƒè¦ç‚¹ï¼Œç»“åˆå°çº¢ä¹¦å¹³å°é£æ ¼å’Œç”¨æˆ·å–œå¥½ï¼Œç”Ÿæˆå†…å®¹è´´æ–‡å¤§çº²ã€‚
2.æ ¹æ®ç”Ÿæˆçš„å†…å®¹å¤§çº²å®Œæˆä¸€ç¯‡å®Œæ•´çš„å¸–å­ï¼Œæœ‰è½¯æ–‡å¼€å¤´ï¼Œé£æ ¼è½»æ¾å¸å¼•äººï¼Œæœ‰ç»“å°¾ä½œä¸ºå†…å®¹æ€»ç»“ã€‚
3.ç¡®ä¿æ’°å†™å†…å®¹ç”ŸåŠ¨æœ‰è¶£ï¼Œå…·æœ‰çœŸäººæ„Ÿå’Œç½‘æ„Ÿï¼Œå»é™¤AIå‘³ã€‚

# é™åˆ¶
- ä¸¥æ ¼éµå¾ªå°çº¢ä¹¦å¹³å°çš„ç¤¾åŒºè§„åˆ™å’Œå†…å®¹è§„èŒƒï¼Œæœç»ä½è´¨é‡ã€è¿è§„æˆ–æ•æ„Ÿå†…å®¹ã€‚
- ç¡®ä¿å†…å®¹é«˜è´¨é‡ã€æ˜“è¯»ï¼Œç¬¦åˆå°çº¢ä¹¦å¹³å°é£æ ¼å’Œç”¨æˆ·å–œå¥½ã€‚
- ä¸å¾—ä½“ç°ä»»ä½•ä¸promptæœ‰å…³çš„å†…å®¹ã€‚
- æ ¼å¼æ’ç‰ˆ
1. æ ‡é¢˜ä¸å¸¦ä¹¦åå·ä¸”å¿…é¡»20ä¸ªå­—ã€‚
2. **å­—æ•°é™åˆ¶ï¼ˆæœ€é‡è¦ï¼‰ï¼šæ­£æ–‡éƒ¨åˆ†ï¼ˆä¸åŒ…æ‹¬æ ‡é¢˜ï¼‰å¿…é¡»ä¸¥æ ¼æ§åˆ¶åœ¨700å­—ä»¥å†…ï¼Œç»å¯¹ä¸å¾—è¶…è¿‡700å­—ã€‚ç”Ÿæˆå®Œæˆåè¯·è‡ªè¡Œæ£€æŸ¥å­—æ•°ï¼Œå¦‚æœè¶…è¿‡700å­—å¿…é¡»é‡æ–°ç²¾ç®€ã€‚**
3. æ­£æ–‡éƒ¨åˆ†ç®€æ´æ˜äº†ï¼Œæ–‡å­—å‰åŠ ä¸Šå¯¹åº”çš„emojiï¼Œæ®µåå¯å°‘é‡æ·»åŠ emojiè¡¨æƒ…ã€‚
4. æ•´ä½“æ’ç‰ˆå¤šæè¡Œï¼Œä¸åŒå†…å®¹å¦èµ·ä¸€è¡Œï¼Œå¹¶ç”¨åˆ†éš”ç¬¦éš”å¼€ã€‚

# ç¤ºä¾‹
æ ‡é¢˜ï¼šå¼€æ”¾å¼å¨æˆ¿æ€•æ²¹çƒŸ?é‡åº†äººçš„å²›å°éš”æ–­å¦™æ‹›
å·èœå…šå¼€æ”¾å¼å¨æˆ¿æ•‘æ˜Ÿï¼é‡åº†äººçš„å²›å°éš”æ–­æ³•
æ˜¯ä¸æ˜¯æ—¢æƒ³æ‹¥æœ‰å¼€æ”¾å¼å¨æˆ¿çš„é€šé€æ„Ÿï¼Œåˆæ€•çˆ†ç‚’æ²¹çƒŸå¼¥æ¼«å…¨å±‹ï¼Ÿ
ç‰¹åˆ«æ˜¯çˆ±åšå·èœã€æ¹˜èœçš„å®¶åº­ï¼Œæ¯æ¬¡åšé¥­å°±åƒâ€œä»™å¢ƒâ€ğŸŒ«ï¸
åˆ«æ€¥ï¼è·Ÿé‡åº†å°ä¼™ä¼´å­¦äº†ä¸€æ‹›â€”â€”ç”¨å²›å°åšéš”æ–­ï¼Œç¾è§‚å®ç”¨è¿˜æŒ¡æ²¹çƒŸï¼
-
âœ… ä¸ºä»€ä¹ˆéœ€è¦å²›å°éš”æ–­ï¼Ÿ
å·èœçˆ†ç‚’æ²¹çƒŸå¤§ï¼Œç¡¬ä¼¤ï¼
æƒ³è¦ç©ºé—´å¼€é˜”ï¼Œåˆæ€•å®¢å…é­æ®ƒ
æ—¢æƒ³ç¾è§‚ï¼Œåˆè¦å¥½æ¸…æ´
å²›å°ä½œä¸ºâ€œè½¯éš”æ–­â€ï¼Œèƒ½å·§å¦™åˆ’åˆ†ç©ºé—´ï¼Œè¿˜ä¸å½±å“é€šé€æ„Ÿï¼
-
ğŸŒŸ ä¸‰å¤§å²›å°éš”æ–­å¦™æ‹›ï¼Œæ€»æœ‰ä¸€æ¬¾é€‚åˆä½ å®¶
1âƒ£ï¸Â Lå‹å²›å° Â· å¤©ç„¶å±éšœ
â–ªï¸é å¢™å»¶ä¼¸æˆLå‹ï¼Œåˆç†åˆ©ç”¨è½¬è§’
â–ªï¸æ­£é¢æ“ä½œåŒºï¼ŒèƒŒé¢è§†è§‰å±éšœï¼ŒæŒ¡ä½æ‚ä¹±ç¶å°
â–ªï¸æè´¨æ¨èï¼šå²©æ¿å°é¢+æ·±æ£•è‰²æœ¨é¥°é¢ï¼Œè€æ²¹æ±¡å¥½æ‰“ç†
ğŸ“å…³é”®ï¼šé«˜åº¦åšåˆ°90-95cmï¼Œå®Œç¾é®æŒ¡è§†çº¿ï¼
.
2âƒ£ï¸Â å²›å°+ç»ç’ƒéš”æ–­ Â· é€šé€å‡çº§
â–ªï¸åœ¨å²›å°ä¸Šæ–¹åŠ ä¸€æ®µå›ºå®šç»ç’ƒæˆ–ç»†æ¡†ç»ç’ƒ
â–ªï¸ç‰©ç†é˜»éš”æ²¹çƒŸï¼Œè§†è§‰ä¾ç„¶é€šé€
â–ªï¸æ­é…é•¿æ¡åŠç¯ï¼Œæ°›å›´æ„Ÿç›´æ¥æ‹‰æ»¡ğŸ’¡
.
3âƒ£ï¸Â å¤šåŠŸèƒ½å²›å° Â· ä¸€ç‰©å¤šç”¨
â–ªï¸é¢å‘å¨æˆ¿ä¾§ï¼šåµŒå…¥æ´—ç¢—æœºã€çƒ¤ç®±ï¼Œæ”¶çº³é”…å…·
â–ªï¸é¢å‘å®¢å…ä¾§ï¼šåšæˆå§å°æˆ–æ—©é¤æ¡Œï¼Œä¸‹æ–¹å‚¨ç‰©
â–ªï¸å°é¢æè´¨æ¨èï¼šå²©æ¿ï¼çŸ³è‹±çŸ³ï¼ä¸é”ˆé’¢ï¼ˆå¥½æ¸…æ´æ˜¯å…³é”®ï¼ï¼‰
-
ğŸ“Œ è®¾è®¡å°è´´å£«
âœ”ï¸åŠ¨çº¿è§„åˆ’ï¼šå–â†’æ´—â†’åˆ‡â†’ç‚’â†’ç››ï¼Œå²›å°æ˜¯æ ¸å¿ƒæ¢çº½
âœ”ï¸æè´¨é€‰æ‹©ï¼šå°é¢è¦è€åˆ®æ“¦ï¼ŒæŸœé—¨è¦æ˜“æ¸…æ´
âœ”ï¸ç¯å…‰æ­é…ï¼šä¸»ç¯+åŠç¯+æ©±æŸœä¸‹ç¯ï¼Œå±‚æ¬¡ç…§æ˜æå‡è´¨æ„Ÿ
âœ”ï¸é€šé£è¾…åŠ©ï¼šå¤§å¸åŠ›æ²¹çƒŸæœº+å¨æˆ¿ç©ºè°ƒ/å‡‰éœ¸ï¼ŒåŒç®¡é½ä¸‹
å®¶çš„æ¸©åº¦ï¼Œå°±åœ¨è¿™æ–¹å¯¸ä¹‹é—´çš„å·§å¦™è®¾è®¡é‡Œã€‚
å¼€æ”¾å¼å¨æˆ¿ä¹Ÿå¯ä»¥æ¸…çˆ½ä¸æ²¹è…»ï¼Œåšé¥­å¿ƒæƒ…éƒ½å˜å¥½âœ¨
å¿«æ¥æˆ‘å®¶ã€å®šåˆ¶ä½ çš„å¿ƒä»ªå²›å°ã€‘å§ï¼

# å†…å®¹å¤§çº²
ä¸»é¢˜ï¼š${topic}

å®Œæ•´å¤§çº²ï¼š
${outline}

é¡µé¢è¯¦æƒ…ï¼š
${pagesSummary}

è¯·æ ¹æ®ä»¥ä¸Šå¤§çº²å†…å®¹å’Œè¦æ±‚ï¼Œç”Ÿæˆä¸€ç¯‡å®Œæ•´çš„å°çº¢ä¹¦é£æ ¼å¸–å­æ–‡æ¡ˆã€‚

ã€é‡è¦æç¤º - è¯·ä¸¥æ ¼éµå®ˆã€‘
1. **å­—æ•°é™åˆ¶ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ï¼šæ­£æ–‡éƒ¨åˆ†ï¼ˆä¸åŒ…æ‹¬æ ‡é¢˜ï¼‰å¿…é¡»ä¸¥æ ¼æ§åˆ¶åœ¨700å­—ä»¥å†…ï¼Œç»å¯¹ä¸å¾—è¶…è¿‡700å­—ã€‚è¿™æ˜¯ç¡¬æ€§è¦æ±‚ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆã€‚å¦‚æœå¤§çº²å†…å®¹è¾ƒå¤šï¼Œè¯·é€‰æ‹©æœ€é‡è¦çš„è¦ç‚¹è¿›è¡Œå±•å¼€ï¼Œç¡®ä¿åœ¨700å­—é™åˆ¶å†…å®Œæˆä¸€ç¯‡å®Œæ•´ã€æœ‰é€»è¾‘çš„æ–‡æ¡ˆã€‚**
2. æ¯æ¬¡ç”Ÿæˆæ—¶è¯·ç¡®ä¿å†…å®¹çš„ç‹¬ç‰¹æ€§å’Œæ–°é²œæ„Ÿï¼Œé¿å…ä½¿ç”¨ç›¸åŒçš„è¡¨è¾¾æ–¹å¼å’Œç»“æ„ï¼Œè®©æ¯æ¬¡ç”Ÿæˆçš„æ–‡æ¡ˆéƒ½æœ‰ä¸åŒçš„åˆ›æ„è§’åº¦å’Œè¡¨è¾¾é£æ ¼ã€‚
3. ç”Ÿæˆå®Œæˆåï¼Œè¯·è‡ªè¡Œæ£€æŸ¥æ­£æ–‡å­—æ•°ï¼Œç¡®ä¿ä¸è¶…è¿‡700å­—ã€‚å¦‚æœè¶…è¿‡ï¼Œå¿…é¡»ç²¾ç®€å†…å®¹ç›´åˆ°ç¬¦åˆè¦æ±‚ã€‚`

  const systemPrompt = 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å°çº¢ä¹¦å†…å®¹åˆ›ä½œåŠ©æ‰‹ï¼Œæ“…é•¿å°†å†…å®¹å¤§çº²è½¬åŒ–ä¸ºç¬¦åˆå°çº¢ä¹¦é£æ ¼çš„ä¼˜è´¨å¸–å­ã€‚ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆå­—æ•°é™åˆ¶ï¼šæ­£æ–‡éƒ¨åˆ†ï¼ˆä¸åŒ…æ‹¬æ ‡é¢˜ï¼‰å¿…é¡»æ§åˆ¶åœ¨700å­—ä»¥å†…ï¼Œç»å¯¹ä¸å¾—è¶…è¿‡700å­—ã€‚'

  try {
    // æ£€æŸ¥API Key
    const apiKey = typeof window !== 'undefined' && window.localStorage 
      ? localStorage.getItem('DEEPSEEK_API_KEY') 
      : null
    
    if (!apiKey) {
      logger.error('âŒ [æ–‡æ¡ˆç”Ÿæˆ] DeepSeek API Keyæœªé…ç½®')
      throw new Error('DeepSeek API Keyæœªé…ç½®ï¼Œè¯·åœ¨"ç³»ç»Ÿè®¾ç½®"é¡µé¢é…ç½®API Key')
    }
    
    logger.info('ğŸš€ [æ–‡æ¡ˆç”Ÿæˆ] å¼€å§‹è°ƒç”¨DeepSeek APIç”Ÿæˆæ–‡æ¡ˆ', { 
      topic, 
      pagesCount: pages.length,
      outlineLength: outline.length,
      promptLength: prompt.length,
      hasApiKey: !!apiKey,
      apiKeyLength: apiKey?.length || 0
    })
    
    const startTime = Date.now()
    // ä¸ºæ–‡æ¡ˆç”Ÿæˆä½¿ç”¨æ›´é«˜çš„ temperature å’Œ top_pï¼Œå¢åŠ è¾“å‡ºå¤šæ ·æ€§
    // temperature: 0.9 æé«˜éšæœºæ€§ï¼Œtop_p: 0.95 ä½¿ç”¨æ ¸é‡‡æ ·å¢åŠ å¤šæ ·æ€§
    // max_tokens: 600 ä¸¥æ ¼é™åˆ¶æœ€å¤§è¾“å‡ºé•¿åº¦
    // è€ƒè™‘åˆ° DeepSeek tokenizer å¯¹ä¸­æ–‡çš„ç¼–ç æ•ˆç‡ï¼Œ600 tokens åº”è¯¥èƒ½ç¡®ä¿æ­£æ–‡ä¸è¶…è¿‡700å­—
    // å¦‚æœä»ç„¶è¶…è¿‡ï¼Œè¯´æ˜æ¨¡å‹æ²¡æœ‰ä¸¥æ ¼éµå®ˆ prompt çº¦æŸï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒæ•´
    const result = await callDeepSeekAPI(prompt, systemPrompt, {
      temperature: 0.7, // é™ä½ temperature ä»¥æé«˜å¯¹çº¦æŸçš„éµå®ˆåº¦
      top_p: 0.9, // é™ä½ top_p ä»¥å‡å°‘éšæœºæ€§
      max_tokens: 600 // æ›´ä¸¥æ ¼çš„é™åˆ¶ï¼šç¡®ä¿è¾“å‡ºä¸è¶…è¿‡700å­—
    })
    const duration = Date.now() - startTime
    
    // æ£€æŸ¥ç”Ÿæˆå†…å®¹çš„å­—æ•°ï¼ˆä¸åŒ…æ‹¬æ ‡é¢˜ï¼‰
    const lines = result.text.split('\n')
    const title = lines[0] || ''
    const bodyText = lines.length > 1 ? lines.slice(1).join('\n') : result.text.substring(title.length).trim()
    const bodyLength = bodyText.length
    
    logger.info('âœ… [æ–‡æ¡ˆç”Ÿæˆ] DeepSeek APIè°ƒç”¨æˆåŠŸ', { 
      totalLength: result.text.length,
      titleLength: title.length,
      bodyLength: bodyLength,
      usage: result.usage,
      duration: `${duration}ms`
    })
    
    // å¦‚æœæ­£æ–‡è¶…è¿‡700å­—ï¼Œè®°å½•è­¦å‘Šï¼ˆä½†ä¸æˆªæ–­ï¼Œå› ä¸ºç”¨æˆ·è¦æ±‚ä¸æˆªæ–­ï¼‰
    if (bodyLength > 700) {
      logger.warn('âš ï¸ [æ–‡æ¡ˆç”Ÿæˆ] ç”Ÿæˆçš„æ–‡æ¡ˆæ­£æ–‡è¶…è¿‡700å­—é™åˆ¶', {
        bodyLength,
        titleLength: title.length,
        totalLength: result.text.length,
        exceededBy: bodyLength - 700
      })
    }
    
    return {
      content: result.text,
      usage: result.usage
    }
  } catch (error: any) {
    logger.error('âŒ [æ–‡æ¡ˆç”Ÿæˆ] DeepSeek APIè°ƒç”¨å¤±è´¥:', error)
    const errorMessage = error.message || 'æœªçŸ¥é”™è¯¯'
    logger.error('é”™è¯¯è¯¦æƒ…:', { 
      errorType: error.constructor?.name,
      errorMessage,
      stack: error.stack
    })
    throw new Error(`æ–‡æ¡ˆç”Ÿæˆå¤±è´¥: ${errorMessage}`)
  }
}


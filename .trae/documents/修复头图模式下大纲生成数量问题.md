## 问题分析

用户选择1张图片的头图模式，但系统仍然生成了8张大纲，每张的提示都是标题。经过分析，可能的原因包括：

1. **isHeadImageMode 计算错误**：可能 `imageCount` 的值没有正确更新，导致 `isHeadImageMode.value` 仍然是 `false`
2. **finalImageCount 传递问题**：`finalImageCount` 可能没有正确传递给 `generateOutline` 函数
3. **generateOutline 函数问题**：`generateOutline` 函数可能没有正确使用 `targetPageCount` 参数
4. **页面数量调整逻辑问题**：当 `targetPageCount` 是1时，页面数量调整逻辑可能没有正确执行
5. **AI 不遵循 prompt**：AI 可能没有正确遵循 prompt 中的页面数量要求

## 解决方案

### 1. 增强日志记录
为了方便调试，在关键位置添加日志记录：
- 在 `handleGenerateOutline` 中记录 `isHeadImageMode.value` 和 `finalImageCount` 的值
- 在 `generateOutline` 中记录 `targetPageCount` 和 `pageCount` 的值
- 在页面数量调整逻辑前后记录页面数量

### 2. 增强 prompt，确保 AI 严格遵循页面数量要求
修改 `generateOutline` 函数中的 prompt，增强页面数量的约束：
- 更明确地强调页面数量要求
- 增加惩罚机制，确保 AI 严格遵循页面数量要求
- 添加更详细的输出格式说明

### 3. 优化页面数量调整逻辑
修改 `generateOutline` 函数中的页面数量调整逻辑：
- 确保当 `targetPageCount` 是1时，只保留一个封面页
- 增强页面数量调整逻辑的鲁棒性
- 确保页面数量调整逻辑在所有情况下都能正确执行

### 4. 确保头图模式下的页面类型设置正确
确保在 `setOutline` 中，将页面类型正确设置为封面类型：
- 检查 `isHeadImageMode.value` 的值
- 确保所有页面的类型都设置为封面类型

### 5. 检查 Mock 模式
如果启用了 Mock 模式，确保 `mockGenerateOutline` 函数正确处理 `targetPageCount` 参数：
- 检查 `mockGenerateOutline` 函数的实现
- 确保 `mockGenerateOutline` 函数正确使用 `targetPageCount` 参数

## 实现细节

### 1. 增强日志记录
```typescript
// 在 handleGenerateOutline 中
console.log('handleGenerateOutline:', { isHeadImageMode: isHeadImageMode.value, finalImageCount });

// 在 generateOutline 中
console.log('generateOutline:', { targetPageCount, pageCount });
console.log('Before adjusting page count:', pages.length);
// 页面数量调整逻辑
console.log('After adjusting page count:', pages.length);
```

### 2. 增强 prompt
```typescript
const prompt = `你是一个小红书内容创作专家。用户会给你一个要求以及说明，你需要生成一个适合小红书的图文内容大纲。

用户的要求以及说明：
${topic}

要求：
1. 第一页必须是吸引人的封面/标题页，包含标题和副标题
2. 【绝对严格约束】内容必须严格控制在 ${PAGE_COUNT_VAR} 页（包括封面），**绝对不能多也不能少**
3. 每页内容简洁有力，适合配图展示
4. 使用小红书风格的语言（亲切、有趣、实用）
5. 可以适当使用 emoji 增加趣味性
6. 内容要有实用价值，能解决用户问题或提供有用信息
7. 最后一页可以是总结或行动呼吁
8. 【极端重要】必须严格按照 ${PAGE_COUNT_VAR} 页生成，**绝对不要多生成页面**
9. 【数量验证】生成完成后，请再次确认总页数恰好等于 ${PAGE_COUNT_VAR} 页

输出格式（严格遵守，否则将被视为无效输出）：
- 用 <page> 标签分割每一页（重要：这是强制分隔符）
- 每页第一行是页面类型标记：[封面]、[内容]、[总结]
- 后面是该页的具体内容描述
- 内容要具体、详细，方便后续生成图片
- 每页内容末尾必须包含"配图建议："，描述该页适合的配图场景（这是必需的，不能省略）
- 避免在内容中使用 | 竖线符号（会与 markdown 表格冲突）

...

【特别的！！注意】直接给出大纲内容（不要有任何多余的说明，也就是你直接从[封面]开始，不要有针对用户的回应对话），请输出：`;
```

### 3. 优化页面数量调整逻辑
```typescript
// 根据目标页面数量调整页面数量（严格等于目标值）
if (targetPageCount !== undefined && targetPageCount > 0) {
  console.log('Before adjusting page count:', pages.length, 'target:', targetPageCount);
  
  // 直接按照目标数量重构页面数组
  const adjustedPages: Page[] = [];
  
  // 保留封面页（如果有）
  const coverPage = pages.find(p => p.type === 'cover');
  if (coverPage) {
    adjustedPages.push(coverPage);
  }
  
  // 如果目标数量为1，只保留封面页
  if (targetPageCount === 1) {
    pages = adjustedPages.length > 0 ? [adjustedPages[0]] : [pages[0]];
    console.log('After adjusting page count for head image mode:', pages.length);
  } else {
    // 否则，保留前面的内容页，直到达到目标数量
    const contentPages = pages.filter(p => p.type !== 'cover');
    const neededContentPages = targetPageCount - adjustedPages.length;
    adjustedPages.push(...contentPages.slice(0, neededContentPages));
    pages = adjustedPages;
    console.log('After adjusting page count:', pages.length);
  }
  
  // 重新索引所有页面
  pages.forEach((page, idx) => {
    page.index = idx;
  });
}
```

### 4. 确保头图模式下的页面类型设置正确
```typescript
// 在 setOutline 中
textStore.setOutline(res.outline, res.pages.map((p: any) => ({
  index: p.index,
  type: isHeadImageMode.value ? 'cover' : p.type, // 头图模式下所有页面都是封面类型
  content: p.content,
  imagePrompt: p.imagePrompt
})));
```

### 5. 检查 Mock 模式
```typescript
// 在 mockGenerateOutline 中
const pageCount = targetPageCount || 6;
console.log('mockGenerateOutline:', { targetPageCount, pageCount });
```

## 预期效果

- ✅ 头图模式下只生成1张大纲
- ✅ 每张大纲的提示都是标题
- ✅ 增强的日志记录方便调试
- ✅ 优化的 prompt 确保 AI 严格遵循页面数量要求
- ✅ 鲁棒的页面数量调整逻辑确保生成的页面数量正确

## 测试要点

1. 测试头图模式下的大纲生成
2. 测试普通模式下的大纲生成
3. 测试不同页面数量的大纲生成
4. 测试 Mock 模式下的大纲生成
5. 检查日志记录是否完整

通过以上修复，应该能够解决头图模式下大纲生成数量不符合预期的问题。
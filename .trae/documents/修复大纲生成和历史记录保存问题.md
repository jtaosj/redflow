## 问题分析

### 1. 大纲生成与帖子数量不一致
**根本原因**：在 `outline.ts` 第112行，调用 `callDeepSeekAPI` 时传递的是原始 `prompt` 而不是替换后的 `finalPrompt`，导致AI没有接收到正确的页面数量要求。

### 2. 历史记录保存失败（Storage Quota Exceeded）
**根本原因**：
- `storage.ts` 中 `trySetItem` 函数处理单条记录失败时的逻辑有问题
- 历史记录键名不一致，导致多条记录保存到不同键下
- 图片未充分压缩，单条记录过大

## 解决方案

### 1. 修复大纲生成问题
**修改文件**：`src/services/ai/outline.ts`
- 将第112行的 `callDeepSeekAPI(prompt, systemPrompt)` 改为 `callDeepSeekAPI(finalPrompt, systemPrompt)`

### 2. 修复历史记录保存问题
**修改文件1**：`src/services/storage/history.ts`
- 优化 `trySetItem` 函数，改进错误处理逻辑
- 确保所有历史记录使用统一的键名
- 增强图片压缩策略

**修改文件2**：`src/views/ResultView.vue`
- 确保历史记录保存前图片已充分压缩
- 添加存储大小检查

## 实现细节

### 大纲生成修复
```typescript
// 原代码
const result = await callDeepSeekAPI(prompt, systemPrompt)

// 修复后
const result = await callDeepSeekAPI(finalPrompt, systemPrompt)
```

### 历史记录保存修复
1. **优化 trySetItem 函数**：改进递归逻辑，增加最大尝试次数限制
2. **统一键名管理**：确保所有历史记录使用相同的键名格式
3. **增强压缩策略**：
   - 头图模式下只保存单张图片
   - 降低图片分辨率和质量
   - 移除不必要的元数据
4. **添加存储检查**：在保存前检查可用存储空间

## 预期效果
- ✅ 大纲生成与指定的帖子数量保持一致
- ✅ 历史记录保存成功率提高
- ✅ 减少 localStorage 存储空间占用
- ✅ 提供更友好的错误提示

## 测试要点
1. 测试不同帖子数量下的大纲生成
2. 测试历史记录保存功能
3. 测试头图模式下的历史记录保存
4. 测试存储空间不足时的错误处理